name: Deploy to Cloudflare Workers

on:
  push:
    tags:
      - "v*" # Production: v1.0.0, v1.2.3
      - "v*b*" # Beta: v1.0.0b1, v1.2.3b2

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        type: choice
        options:
          - beta
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Frontend to Cloudflare Workers

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # - name: Type check
      #   run: pnpm typecheck

      # - name: Run tests
      #   run: pnpm test

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ refs/tags/v.*b.* ]]; then
            echo "environment=beta" >> $GITHUB_OUTPUT
          else
            echo "environment=production" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Beta
        if: steps.env.outputs.environment == 'beta'
        run: pnpm deploy:beta
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Production
        if: steps.env.outputs.environment == 'production'
        run: pnpm deploy:production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deployment Summary
        run: |
          echo "### ðŸš€ Frontend Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.env.outputs.environment }}" == "beta" ]]; then
            echo "**Worker:** memento-beta" >> $GITHUB_STEP_SUMMARY
            echo "**URL:** https://beta.memento.oddlab.cc" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Worker:** memento" >> $GITHUB_STEP_SUMMARY
            echo "**URL:** https://memento.oddlab.cc" >> $GITHUB_STEP_SUMMARY
          fi
